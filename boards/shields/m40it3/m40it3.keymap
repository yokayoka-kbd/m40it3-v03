#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/input_transform.h>
#include <dt-bindings/zmk/pointing.h>

/* 外部のキーマップ本体を読み込む */
#include "../../../config/keymap.keymap"

/ {
    /* 通常のXY移動用：REL_XとREL_Yをそのまま使う */
    zip_xy_transform: zip_xy_transform {
        compatible = "zmk,input-processor-transform";
        #input-processor-cells = <1>;
        type = <0x02>; /* INPUT_EV_REL */
        x-codes = <0x00>; /* REL_X */
        y-codes = <0x01>; /* REL_Y */
    };

    /* スクロール変換用：センサーの値を垂直・水平ホイールに振り分ける */
    zip_scroll_transform: zip_scroll_transform {
        compatible = "zmk,input-processor-transform";
        #input-processor-cells = <1>;
        type = <0x02>; /* INPUT_EV_REL */
        /* 軸調整：垂直スクロール(0x08)と水平スクロール(0x06)にマッピング */
        x-codes = <0x01>, <0x08>; 
        y-codes = <0x00>, <0x06>;
    };

    /* トラックボールの挙動を管理するリスナー */
    trackball_listener: trackball_listener {
        compatible = "zmk,input-listener";
        device = <&trackball>;

        /* 通常時：あなたが使い慣れている軸設定（XY入れ替え＋X反転） */
        input-processors = <&zip_xy_transform (INPUT_TRANSFORM_XY_SWAP | INPUT_TRANSFORM_X_INVERT)>;

        /* レイヤー1（mo 1）がONの時だけ、上記の設定をスクロールに上書き */
        scrolling {
            layers = <1>; 
            input-processors = <&zip_scroll_transform 0>;
        };
    };
};
