#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/zmk/input_transform.h>
#include "layouts.dtsi"

/* ▽ 定義部分：通常用とスクロール用を明確に分けました ▽ */
/ {
    /* 1. 通常のカーソル移動用：中身は空（trackball_listener側で入れ替え指定） */
    zip_xy_transform: zip_xy_transform {
        compatible = "zmk,input-processor-transform";
        #input-processor-cells = <1>;
        type = <0x02>; /* REL */
        x-codes = <0x00>; /* X */
        y-codes = <0x01>; /* Y */
    };

    /* 2. スクロール専用：ここ自体に入れ替えと反転を組み込んでしまいます */
    zip_scroll_transform: zip_scroll_transform {
        compatible = "zmk,input-processor-transform";
        #input-processor-cells = <0>;
        type = <0x02>;
        /* あなたのキーボードの軸（XY_SWAP | X_INVERT）をスクロール用に計算済み */
        x-codes = <0x01>, <0x08>; /* センサーのYをホイール(垂直)に */
        y-codes = <0x00>, <0x06>; /* センサーのXを反転させて水平スクロールに */
    };
};

/ {
    /* ... chosen, default_transform, kscan0 は変更なし ... */

    trackball_listener: trackball_listener {
        compatible = "zmk,input-listener";
        device = <&trackball>;

        /* ▽ レイヤーに関わらず、ベースとなるXY入れ替え設定 ▽ */
        /* これにより「通常時」は今まで通りの動きが維持されます */
        input-processors = <&zip_xy_transform (INPUT_TRANSFORM_XY_SWAP | INPUT_TRANSFORM_X_INVERT)>;

        /* ▽ レイヤー1の時だけスクロールに切り替え ▽ */
        scrolling {
            layers = <1>;
            /* 上記のXY変換を「無視して」、スクロール専用の軸設定を適用します */
            input-processors = <&zip_scroll_transform>;
        };
    };
};
